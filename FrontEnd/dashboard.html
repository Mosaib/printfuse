<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Dashboard</h2>
      <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
    </div>

    <div class="card p-4 mb-4 shadow-sm">
      <h4>Create New Company</h4>
      <form id="createCompanyForm" class="row g-3">
        <div class="col-md-4">
          <input type="text" id="newName" class="form-control" placeholder="Company Name" required>
        </div>
        <div class="col-md-4">
          <input type="text" id="newAddress" class="form-control" placeholder="Address">
        </div>
        <div class="col-md-3">
          <input type="text" id="newIndustry" class="form-control" placeholder="Industry">
        </div>
        <div class="col-md-1 d-grid">
          <button type="submit" class="btn btn-success">Create</button>
        </div>
      </form>
    </div>

    <div class="card p-4 mb-4 shadow-sm">
      <h4>Active Company</h4>
      <div id="activeCompany" class="fw-bold text-primary">Loading...</div>
    </div>

    <div class="card p-4 shadow-sm">
      <h4>Your Companies</h4>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle mt-3">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Address</th>
              <th>Industry</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="companiesList">
            <tr><td colspan="4" class="text-center">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const token = localStorage.getItem("auth_token");
    if (!token) window.location.href = "login.html";

    // get active company
    let activeCompanyId = null;
    async function fetchActiveCompany() {
      try {
        let response = await fetch("http://127.0.0.1:8000/api/company/active", {
          headers: {
            "Authorization": "Bearer " + token,
            "Accept": "application/json"
          }
        });

        let result = await response.json();
        let activeDiv = document.getElementById("activeCompany");

        if (response.ok && result.data) {
          activeCompanyId = result.data.company_id;
          activeDiv.innerHTML = `
            <span class="text-dark">${result.data.company.name}</span><br>
            <small>${result.data.company.address || "No Address"} | ${result.data.company.industry || "N/A"}</small>
          `;
        } else {
          activeCompanyId = null;
          activeDiv.innerHTML = `<em>No active company selected</em>`;
        }
      } catch (error) {
        console.error("Error fetching active company:", error);
        document.getElementById("activeCompany").innerHTML = "<em>Error loading active company</em>";
      }
    }


    // get companies
    async function fetchCompanies() {
      try {
        let response = await fetch("http://127.0.0.1:8000/api/companies", {
          headers: {
            "Authorization": "Bearer " + token,
            "Accept": "application/json"
          }
        });

        let data = await response.json();
        let tableBody = document.getElementById("companiesList");
        tableBody.innerHTML = "";

        let companies = [];
        if (Array.isArray(data)) {
          companies = data;
        } else if (data.data && Array.isArray(data.data)) {
          companies = data.data;
        }

        if (!companies.length) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center">No companies found</td></tr>`;
          return;
        }

        companies.forEach(company => {
          let row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <input type="text" id="updateName-${company.id}" value="${company.name}" class="form-control form-control-sm">
            </td>
            <td>
              <input type="text" id="updateAddress-${company.id}" value="${company.address || ""}" class="form-control form-control-sm">
            </td>
            <td>
              <input type="text" id="updateIndustry-${company.id}" value="${company.industry || ""}" class="form-control form-control-sm">
            </td>
            <td>
              <button class="btn btn-sm btn-primary me-1" onclick="switchCompany(${company.id})">Switch</button>
              <button class="btn btn-sm btn-success me-1" onclick="updateCompany(${company.id})">Update</button>
              <button class="btn btn-sm btn-danger" onclick="deleteCompany(${company.id})">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (err) {
        console.error("Error fetching companies:", err);
        document.getElementById("companiesList").innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error loading companies</td></tr>`;
      }
    }

    // get active the companu
    async function switchCompany(id) {
      try {
        let response = await fetch("http://127.0.0.1:8000/api/company/switch", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ company_id: id })
        });

        let result = await response.json();
        if (response.ok) {
          fetchActiveCompany();
          fetchCompanies();
        } else {
          alert("Failed to switch: " + (result.message || "Unknown error"));
        }
      } catch (error) {
        console.error("Error switching company:", error);
        alert("Error switching company.");
      }
    }

    // create a new company
    document.getElementById("createCompanyForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      let formData = {
        name: document.getElementById("newName").value,
        address: document.getElementById("newAddress").value,
        industry: document.getElementById("newIndustry").value
      };
      let response = await fetch("http://127.0.0.1:8000/api/companies", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(formData)
      });
      await response.json();
      fetchCompanies();
    });

    // update the company
    async function updateCompany(id) {
      let formData = {
        id: id,
        name: document.getElementById("updateName-" + id).value,
        address: document.getElementById("updateAddress-" + id).value,
        industry: document.getElementById("updateIndustry-" + id).value
      };
      let response = await fetch("http://127.0.0.1:8000/api/companyUpdate", {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(formData)
      });
      await response.json();
      fetchCompanies();
      fetchActiveCompany();
    }

    // delete the company
    async function deleteCompany(id) {
      let response = await fetch("http://127.0.0.1:8000/api/companyDelete", {
        method: "DELETE",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({ id: id })
      });
      await response.json();
      fetchCompanies();
      fetchActiveCompany();
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("auth_token");
      window.location.href = "login.html";
    });

    fetchActiveCompany();
    fetchCompanies();
  </script>
</body>
</html>
